<!DOCTYPE html>
<html lang="en-GB">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Quick Capacity</title>
  <style>
    :root{
      /* Teal + White */
      --primary:#1aa6a6;
      --primary-2:#128787;
      --border:#DEE2E6;
      --bg:#F6F8FA;
      --card:#FFFFFF;
      --text:#1f2937;
      --muted:#6b7280;
      --pill:#e7fbfb;
      --warn:#f59e0b;
      --bad:#dc2626;
      --good:#16a34a;
    }

    /* App-wide font */
    body, h1, h2, h3, h4, h5, h6, p, div, span, label, button, input, select, textarea, th, td, li, ul, ol, details, summary, pre, code{
      font-family:'Aptos','Segoe UI',Arial,sans-serif;
    }

    body{
      margin:20px;
      padding:20px;
      max-width:1400px;
      background:var(--bg);
      color:var(--text);
    }

    /* Header */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:16px;
    }
    .brand{
      display:flex;
      align-items:baseline;
      gap:10px;
    }
    .brand h1{
      margin:0;
      font-size:28px;
      letter-spacing:.2px;
    }
    .brand .sub{
      color:var(--muted);
      font-weight:600;
      font-size:13px;
    }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:12px;
      padding:24px;
      margin-top:16px;
      box-shadow:0 1px 3px rgba(0,0,0,.08);
    }

    .layout{
      display:grid;
      grid-template-columns: 420px 1fr;
      gap:16px;
      align-items:start;
    }
    @media (max-width: 1100px){
      .layout{ grid-template-columns:1fr; }
    }

    label{
      display:block;
      font-weight:600;
      margin-bottom:6px;
    }

    select,input,button{
      padding:10px;
      border:1px solid var(--border);
      border-radius:8px;
      background:var(--card);
      font-size:14px;
    }

    button{
      background:var(--primary);
      border-color:transparent;
      color:white;
      font-weight:700;
      cursor:pointer;
      transition:background .15s ease;
    }
    button:hover{ background:var(--primary-2); }
    button.secondary{
      background:white;
      color:var(--primary);
      border:2px solid var(--primary);
    }
    button.secondary:hover{ background:var(--pill); }
    button:disabled{ opacity:.6; cursor:not-allowed; }

    .controls{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(180px, 1fr));
      gap:14px 14px;
      align-items:end;
    }
    .controls .row2{
      grid-column:1/-1;
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:14px;
    }
    @media (max-width:520px){
      .controls .row2{ grid-template-columns:1fr; }
    }

    .muted{ color:var(--muted); }
    .pill{
      display:inline-block;
      background:var(--pill);
      border:1px solid var(--border);
      border-radius:999px;
      padding:2px 10px;
      font-size:12px;
      font-weight:700;
      color:var(--primary-2);
      margin-left:8px;
      vertical-align:middle;
    }

    .section-title{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin:0 0 12px;
    }
    .section-title h2{
      margin:0;
      font-size:18px;
    }

    .btn-row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:12px;
    }

    /* Output tiles */
    .tiles{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(180px, 1fr));
      gap:12px;
      margin-top:12px;
    }
    .tile{
      border:1px solid var(--border);
      border-radius:10px;
      padding:14px 14px;
      background:var(--card);
    }
    .tile .k{
      color:var(--muted);
      font-weight:700;
      font-size:12px;
      letter-spacing:.2px;
      text-transform:uppercase;
    }
    .tile .v{
      font-size:22px;
      font-weight:800;
      margin-top:6px;
      color:var(--primary-2);
    }
    .tile .s{
      margin-top:6px;
      font-size:12px;
      color:var(--muted);
    }

    /* Chart */
    .chart-wrap{
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
      overflow:hidden;
      background:#fff;
    }
    canvas{ display:block; width:100%; height:260px; }

    /* Table */
    table{
      width:100%;
      border-collapse:collapse;
      margin-top:12px;
      font-size:13px;
    }
    thead th{
      background:var(--primary);
      color:white;
      text-align:left;
      padding:10px;
      border-bottom:1px solid var(--border);
      position:sticky;
      top:0;
      z-index:1;
    }
    tbody td{
      padding:9px 10px;
      border-bottom:1px solid var(--border);
      vertical-align:top;
    }
    tbody tr:hover{ background:#f8ffff; }
    .right{ text-align:right; }
    .center{ text-align:center; }
    .badge{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      font-size:12px;
      font-weight:800;
      border:1px solid var(--border);
    }
    .b-good{ color:var(--good); background:#ecfdf5; border-color:#bbf7d0; }
    .b-warn{ color:var(--warn); background:#fffbeb; border-color:#fde68a; }
    .b-bad{  color:var(--bad);  background:#fef2f2; border-color:#fecaca; }

    /* Health check box */
    .health{
      border:2px solid var(--primary);
      border-radius:12px;
      padding:16px;
      background:transparent;
      margin-top:12px;
    }
    .health h3{ margin:0 0 10px; color:var(--primary-2); }
    .health ul{ margin:8px 0 0; padding-left:18px; }
    .health li{ margin:6px 0; }
    .mini{
      font-size:12px;
      color:var(--muted);
    }

    /* File input style */
    input[type="file"]{
      padding:8px;
      background:white;
    }

    /* Small hint box */
    .hint{
      background:#f8ffff;
      border-left:4px solid var(--primary);
      border-radius:10px;
      padding:12px 12px;
      margin-top:10px;
      font-size:13px;
    }

    .footer-note{
      margin-top:10px;
      font-size:12px;
      color:var(--muted);
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="brand">
      <h1>Quick Capacity</h1>
      <span class="sub">Capacity planner + overtime health check</span>
    </div>
  </div>

  <div class="layout">
    <!-- LEFT: Inputs -->
    <div>
      <div class="card">
        <div class="section-title">
          <h2>1) Business schedule</h2>
          <span class="pill">Opening hours</span>
        </div>
        <div class="controls">
          <div>
            <label for="openDays">Open days / week</label>
            <input id="openDays" type="number" min="1" max="7" value="7">
          </div>
          <div>
            <label for="openHours">Open hours / day</label>
            <input id="openHours" type="number" min="1" max="24" value="24">
          </div>
          <div class="row2">
            <div>
              <label for="openingTime">Opening time (24h)</label>
              <input id="openingTime" type="time" value="00:00">
            </div>
            <div>
              <label for="timezoneNote">Timezone</label>
              <input id="timezoneNote" type="text" value="Local (browser)" disabled>
            </div>
          </div>
        </div>

        <div class="hint">
          Upload a forecast (CSV), pick your interval, then we‚Äôll calculate staffing, SL/ASA/ABD and an overtime ‚Äúuh-oh‚Äù list.
        </div>
      </div>

      <div class="card">
        <div class="section-title">
          <h2>2) Forecast upload & shaping</h2>
          <span class="pill">Your data</span>
        </div>

        <div class="controls">
          <div style="grid-column:1/-1">
            <label for="forecastFile">Upload forecast CSV</label>
            <input id="forecastFile" type="file" accept=".csv">
            <div class="mini" style="margin-top:6px;">
              Expected columns (any of these names are fine):<br>
              <span class="mono">datetime / timestamp / interval_start</span> and <span class="mono">volume</span>
              (optional: <span class="mono">aht_seconds</span> per row).
            </div>
          </div>

          <div>
            <label for="intervalSelect">Interval level</label>
            <select id="intervalSelect">
              <option value="15">15 minutes</option>
              <option value="30">30 minutes</option>
              <option value="45">45 minutes</option>
              <option value="60" selected>60 minutes</option>
              <option value="1440">Day</option>
            </select>
          </div>

          <div>
            <label for="ahtGlobal">AHT (seconds) if missing</label>
            <input id="ahtGlobal" type="number" min="1" value="300">
          </div>

          <div>
            <label for="pctChange">Adjust forecast by %</label>
            <input id="pctChange" type="number" step="0.1" value="0">
          </div>

          <div>
            <label for="volDelta">Adjust forecast by volume (add/sub)</label>
            <input id="volDelta" type="number" step="1" value="0">
          </div>
        </div>

        <div class="btn-row">
          <button id="applyForecastBtn">Apply changes</button>
          <button id="resetForecastBtn" class="secondary">Reset to uploaded</button>
          <button id="downloadForecastBtn" class="secondary" disabled>Download modified CSV</button>
        </div>

        <div id="forecastStatus" class="footer-note"></div>
      </div>

      <div class="card">
        <div class="section-title">
          <h2>3) Staffing model</h2>
          <span class="pill">Supply</span>
        </div>

        <div class="controls">
          <div>
            <label for="shiftLen">Agent shift length (hrs)</label>
            <input id="shiftLen" type="number" min="1" max="12" value="8">
          </div>
          <div>
            <label for="daysPerWeek">Agent days / week</label>
            <input id="daysPerWeek" type="number" min="1" max="7" value="5">
          </div>
          <div>
            <label for="shrinkPct">Total shrinkage (%)</label>
            <input id="shrinkPct" type="number" min="0" max="80" step="0.5" value="30">
          </div>
          <div>
            <label for="offlinePct">Offline time (%)</label>
            <input id="offlinePct" type="number" min="0" max="80" step="0.5" value="10">
          </div>

          <div style="grid-column:1/-1">
            <label for="staffingMode">Staffing input mode</label>
            <select id="staffingMode">
              <option value="fte">Constant FTE across opening hours</option>
              <option value="interval">Upload/enter staff per interval (CSV)</option>
            </select>
          </div>

          <div id="fteBlock" style="grid-column:1/-1;">
            <label for="fteInput">FTE available (within opening hours)</label>
            <input id="fteInput" type="number" min="0" step="0.25" value="15">
            <div class="mini" style="margin-top:6px;">We‚Äôll treat this as agents ‚Äúon phones‚Äù before shrink/offline adjustments.</div>
          </div>

          <div id="staffFileBlock" style="grid-column:1/-1; display:none;">
            <label for="staffFile">Upload staffing CSV</label>
            <input id="staffFile" type="file" accept=".csv">
            <div class="mini" style="margin-top:6px;">
              Columns: <span class="mono">datetime</span>, <span class="mono">staff</span>. Interval should match your chosen interval.
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="section-title">
          <h2>4) Targets</h2>
          <span class="pill">SLA</span>
        </div>

        <div class="controls">
          <div>
            <label for="slTarget">Service level (%)</label>
            <input id="slTarget" type="number" min="0" max="100" step="1" value="80">
          </div>
          <div>
            <label for="slSeconds">SL seconds goal</label>
            <input id="slSeconds" type="number" min="1" step="1" value="120">
          </div>
          <div>
            <label for="maxWait">Max wait cap (sec)</label>
            <input id="maxWait" type="number" min="10" step="10" value="3600">
          </div>
          <div>
            <label for="abandonRateAssumption">Abandon rate model</label>
            <select id="abandonRateAssumption">
              <option value="simple" selected>Simple (based on ASA vs patience)</option>
              <option value="none">Assume 0 abandon</option>
            </select>
          </div>
          <div style="grid-column:1/-1">
            <label for="patienceSec">Customer patience (sec) (used for ABD estimate)</label>
            <input id="patienceSec" type="number" min="10" step="10" value="180">
          </div>
        </div>

        <div class="btn-row">
          <button id="calcBtn">Calculate requirements</button>
          <button id="clearBtn" class="secondary">Clear</button>
        </div>
      </div>
    </div>

    <!-- RIGHT: Outputs -->
    <div>
      <div class="card">
        <div class="section-title">
          <h2>Calculated forecast</h2>
          <span class="pill" id="periodPill">No data</span>
        </div>

        <div class="tiles" id="summaryTiles">
          <div class="tile">
            <div class="k">Total volume</div>
            <div class="v" id="tVol">‚Äî</div>
            <div class="s muted">Opening hours only</div>
          </div>
          <div class="tile">
            <div class="k">Occupancy</div>
            <div class="v" id="tOcc">‚Äî</div>
            <div class="s muted">Workload / staffed time</div>
          </div>
          <div class="tile">
            <div class="k">Service level</div>
            <div class="v" id="tSL">‚Äî</div>
            <div class="s muted">Targeted interval calc</div>
          </div>
          <div class="tile">
            <div class="k">ASA</div>
            <div class="v" id="tASA">‚Äî</div>
            <div class="s muted">Average speed of answer</div>
          </div>
          <div class="tile">
            <div class="k">ABD</div>
            <div class="v" id="tABD">‚Äî</div>
            <div class="s muted">Estimated abandon rate</div>
          </div>
        </div>

        <div style="display:grid; grid-template-columns:1.2fr .8fr; gap:12px; margin-top:12px;">
          <div class="chart-wrap">
            <div class="mini" style="margin:4px 0 8px;">
              Staffing vs requirement (opening hours)
            </div>
            <canvas id="barChart" width="900" height="260" aria-label="Staffing chart"></canvas>
          </div>

          <div class="health">
            <h3>Overtime health check</h3>
            <div class="mini" id="healthHeadline">Upload a forecast and hit ‚ÄúCalculate requirements‚Äù.</div>
            <ul id="healthList"></ul>
            <div class="footer-note" id="healthTotals"></div>
          </div>
        </div>

        <div style="margin-top:12px; display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap;">
          <div class="mini">
            Table shows <strong>opening hours only</strong>. Closed intervals are excluded (we‚Äôre not paying agents to stare at a closed phone line‚Ä¶ usually).
          </div>
          <div class="btn-row" style="margin-top:0;">
            <button id="downloadResultsBtn" class="secondary" disabled>Download results CSV</button>
          </div>
        </div>

        <div style="max-height:520px; overflow:auto; border:1px solid var(--border); border-radius:12px; margin-top:12px;">
          <table id="resultsTable">
            <thead>
              <tr>
                <th style="min-width:170px;">Interval</th>
                <th class="right">Volume</th>
                <th class="right">AHT (s)</th>
                <th class="right">Workload (hrs)</th>
                <th class="right">Staff available</th>
                <th class="right">Staff required</th>
                <th class="center">Status</th>
                <th class="right">Occ</th>
                <th class="right">SL</th>
                <th class="right">ASA (s)</th>
                <th class="right">ABD</th>
                <th class="right">Overtime (hrs)</th>
              </tr>
            </thead>
            <tbody id="resultsBody">
              <tr><td colspan="12" class="muted" style="padding:16px;">No results yet.</td></tr>
            </tbody>
          </table>
        </div>

        <div class="footer-note" id="calcNotes"></div>
      </div>
    </div>
  </div>

<script>
/* ---------------------------
   Quick Capacity (no APIs)
   - Upload forecast CSV
   - Aggregate to interval
   - Apply % / volume deltas
   - Opening hours filter
   - Erlang C queue maths for SL/ASA
   - ABD estimate (optional)
   - Overtime health check
---------------------------- */

const $ = (id)=>document.getElementById(id);

const state = {
  rawForecast: [],      // uploaded rows (datetime, volume, ahtSeconds?)
  baseSeries: [],       // normalised to selected interval before adjustments
  series: [],           // adjusted series
  staffSeries: null,    // optional staff per interval
  lastResults: [],      // computed output per interval
  lastSummary: null
};

function parseCSV(text){
  // simple CSV parser (handles commas, trims, ignores empty lines)
  const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  if(!lines.length) return {headers:[], rows:[]};

  const splitLine = (line)=>{
    // minimal quote handling
    const out=[];
    let cur="", inQ=false;
    for(let i=0;i<line.length;i++){
      const ch=line[i];
      if(ch === '"' ){
        if(inQ && line[i+1] === '"'){ cur+='"'; i++; }
        else inQ = !inQ;
      } else if(ch === ',' && !inQ){
        out.push(cur.trim()); cur="";
      } else cur+=ch;
    }
    out.push(cur.trim());
    return out;
  };

  const headers = splitLine(lines[0]).map(h=>h.toLowerCase());
  const rows = [];
  for(let i=1;i<lines.length;i++){
    const cols = splitLine(lines[i]);
    if(cols.every(c=>c==="")) continue;
    const obj={};
    headers.forEach((h,idx)=>obj[h]= (cols[idx] ?? "").trim());
    rows.push(obj);
  }
  return {headers, rows};
}

function pick(obj, names){
  for(const n of names){
    if(obj[n] != null && obj[n] !== "") return obj[n];
  }
  return null;
}

function parseDateSmart(s){
  // supports ISO, "YYYY-MM-DD HH:mm", etc.
  if(!s) return null;
  const d = new Date(s);
  if(!isNaN(+d)) return d;
  // try replacing space with T
  const d2 = new Date(String(s).replace(" ", "T"));
  if(!isNaN(+d2)) return d2;
  return null;
}

function toISOMinute(d){
  const z = (n)=>String(n).padStart(2,'0');
  return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())} ${z(d.getHours())}:${z(d.getMinutes())}`;
}

function floorToInterval(date, minutes){
  const ms = minutes*60*1000;
  return new Date(Math.floor(+date/ms)*ms);
}

function addMinutes(date, minutes){
  return new Date(+date + minutes*60*1000);
}

function businessWindowForDate(date){
  const openHours = clampNum(+$('openHours').value, 1, 24);
  const openingTime = $('openingTime').value || "00:00";
  const [hh, mm] = openingTime.split(':').map(x=>+x||0);

  const start = new Date(date.getFullYear(), date.getMonth(), date.getDate(), hh, mm, 0, 0);
  const end = addMinutes(start, openHours*60);
  return {start, end};
}

function isOpen(date){
  const openDays = clampNum(+$('openDays').value, 1, 7);
  // JS: 0 Sun ... 6 Sat. We'll treat "openDays" as first N days starting Mon.
  // Simpler: if openDays = 7 -> always open. If <7 -> closed on last (7-openDays) days of week (Sat/Sun first?).
  // We'll do: open days are Mon..(Mon+openDays-1). i.e. openDays=5 => Mon-Fri.
  if(openDays < 7){
    const dow = (date.getDay()+6)%7; // 0 Mon ... 6 Sun
    if(dow >= openDays) return false;
  }
  const {start, end} = businessWindowForDate(date);
  return (+date >= +start && +date < +end);
}

function clampNum(n, min, max){
  if(!isFinite(n)) return min;
  return Math.min(max, Math.max(min, n));
}

function pct(n){ return (n*100).toFixed(1) + '%'; }

function fmtNum(n, dp=0){
  if(n==null || !isFinite(n)) return '‚Äî';
  return n.toLocaleString(undefined, {maximumFractionDigits:dp, minimumFractionDigits:dp});
}

function fmtSecs(n){
  if(n==null || !isFinite(n)) return '‚Äî';
  return fmtNum(Math.max(0,n), 0);
}

function badgeForStatus(status){
  if(status==='OK') return `<span class="badge b-good">OK</span>`;
  if(status==='Tight') return `<span class="badge b-warn">Tight</span>`;
  return `<span class="badge b-bad">Deficit</span>`;
}

/* ---------------------------
   Erlang C / Queue maths
   Based on M/M/c with offered load a = Œª * AHT
---------------------------- */
function erlangB(a, c){
  // recursive stable
  let b = 1.0;
  for(let i=1;i<=c;i++){
    b = (a*b) / (i + a*b);
  }
  return b;
}

function erlangC(a, c){
  if(c <= 0) return 1;
  if(a <= 0) return 0;
  if(a >= c) return 1; // overloaded => infinite queue in theory; treat as 1
  // Use standard formulation:
  // P(wait) = ( (a^c / c!) * (c/(c-a)) ) / ( sum_{k=0}^{c-1} a^k/k! + (a^c/c!) * (c/(c-a)) )
  // We'll compute recursively for sum to avoid factorial blowups.
  let sum = 1.0;
  let term = 1.0;
  for(let k=1;k<=c-1;k++){
    term *= a/k;
    sum += term;
  }
  // term is now a^(c-1)/(c-1)!
  const termC = term * (a / c); // a^c / c!
  const top = termC * (c / (c - a));
  const bottom = sum + top;
  return top / bottom;
}

function serviceLevel(a, c, tSec, ahtSec){
  if(c<=0) return 0;
  if(a<=0) return 1;
  const pw = erlangC(a, c);
  if(pw >= 1) return 0;
  const expo = - (c - a) * (tSec / ahtSec);
  return 1 - (pw * Math.exp(expo));
}

function asaSeconds(a, c, ahtSec, maxWaitSec){
  if(c<=0) return maxWaitSec;
  if(a<=0) return 0;
  const pw = erlangC(a, c);
  if(pw >= 1) return maxWaitSec;
  const wq = (pw * ahtSec) / (c - a); // expected waiting time in queue
  return Math.min(maxWaitSec, Math.max(0, wq));
}

function requiredAgentsForSL(a, ahtSec, slTarget, slSec, capC=500){
  // Find smallest c meeting SL. Bounded search.
  if(a<=0) return 0;
  const target = slTarget;
  let c = Math.max(1, Math.ceil(a)); // start around load
  // push up until stable-ish or meets target
  for(let i=0;i<capC;i++){
    const sl = serviceLevel(a, c, slSec, ahtSec);
    if(sl >= target) return c;
    c++;
  }
  return c;
}

function estimateAbandonRate(asaSec, patienceSec){
  // Simple proxy: P(abandon) ‚âà 1 - e^(-ASA/patience)
  // (Not a real-world law; useful as a quick directional ‚Äúhealth check‚Äù.)
  if(patienceSec<=0) return 0;
  return 1 - Math.exp(-Math.max(0,asaSec)/patienceSec);
}

/* ---------------------------
   Forecast normalisation
---------------------------- */
function normaliseForecastToInterval(rows, intervalMin){
  // group by floored interval
  const map = new Map(); // key -> {dt, vol, ahtW, ahtSum}
  for(const r of rows){
    const dtRaw = pick(r, ['datetime','timestamp','interval_start','start','date','time']);
    const volRaw = pick(r, ['volume','vol','calls','contacts','demand']);
    const ahtRaw = pick(r, ['aht_seconds','aht','ahts','handle_time_seconds','handle_time']);

    const dt = parseDateSmart(dtRaw);
    if(!dt) continue;
    const vol = Number(volRaw);
    if(!isFinite(vol)) continue;

    const bucket = floorToInterval(dt, intervalMin);
    const key = +bucket;

    const ahtSec = isFinite(Number(ahtRaw)) ? Number(ahtRaw) : null;

    if(!map.has(key)){
      map.set(key, { dt: bucket, volume: 0, ahtWeightedSum: 0, ahtWeight: 0 });
    }
    const obj = map.get(key);
    obj.volume += vol;

    if(ahtSec!=null){
      // weight by volume (reasonable default)
      obj.ahtWeightedSum += ahtSec * vol;
      obj.ahtWeight += vol;
    }
  }

  const ahtFallback = clampNum(+$('ahtGlobal').value, 1, 999999);

  const series = [...map.values()]
    .sort((a,b)=>+a.dt - +b.dt)
    .map(x=>({
      dt: x.dt,
      volume: x.volume,
      ahtSec: x.ahtWeight>0 ? (x.ahtWeightedSum/x.ahtWeight) : ahtFallback
    }));

  return series;
}

function applyForecastAdjustments(baseSeries){
  const pctChange = Number($('pctChange').value) || 0;
  const volDelta = Number($('volDelta').value) || 0;

  const mult = 1 + (pctChange/100);

  return baseSeries.map(p=>{
    const v = Math.max(0, (p.volume * mult) + volDelta);
    return { ...p, volume: v };
  });
}

function filterToOpeningHours(series){
  return series.filter(p=>isOpen(p.dt));
}

/* ---------------------------
   Staffing series
---------------------------- */
function normaliseStaffToInterval(rows, intervalMin){
  const map = new Map();
  for(const r of rows){
    const dtRaw = pick(r, ['datetime','timestamp','interval_start','start','date','time']);
    const staffRaw = pick(r, ['staff','fte','agents','scheduled']);
    const dt = parseDateSmart(dtRaw);
    if(!dt) continue;
    const staff = Number(staffRaw);
    if(!isFinite(staff)) continue;
    const bucket = floorToInterval(dt, intervalMin);
    const key = +bucket;
    map.set(key, { dt: bucket, staff });
  }
  return [...map.values()].sort((a,b)=>+a.dt - +b.dt);
}

function staffForInterval(dt, intervalMin){
  const mode = $('staffingMode').value;
  if(mode === 'fte'){
    return clampNum(+$('fteInput').value, 0, 999999);
  }
  // interval mode
  if(!state.staffSeries) return 0;
  const key = +floorToInterval(dt, intervalMin);
  const hit = state.staffSeries.find(x=>+x.dt === key);
  return hit ? (hit.staff || 0) : 0;
}

function effectiveStaff(staff){
  // Apply shrink and offline as reductions to ‚Äúavailable to take contacts‚Äù
  const shrink = clampNum(+$('shrinkPct').value, 0, 95) / 100;
  const offline = clampNum(+$('offlinePct').value, 0, 95) / 100;
  const eff = staff * (1 - shrink) * (1 - offline);
  return Math.max(0, eff);
}

/* ---------------------------
   Core calculation
---------------------------- */
function compute(){
  const intervalMin = Number($('intervalSelect').value);

  if(!state.rawForecast.length){
    setStatus('Please upload a forecast CSV first.', true);
    return;
  }

  // normalise + apply adjustments
  state.baseSeries = normaliseForecastToInterval(state.rawForecast, intervalMin);
  state.series = applyForecastAdjustments(state.baseSeries);

  const openSeries = filterToOpeningHours(state.series);
  if(!openSeries.length){
    setStatus('No forecast intervals fall within opening hours/days. Check schedule settings.', true);
    return;
  }

  const slTarget = clampNum((+$('slTarget').value)/100, 0, 1);
  const slSeconds = clampNum(+$('slSeconds').value, 1, 999999);
  const maxWait = clampNum(+$('maxWait').value, 10, 999999);
  const patience = clampNum(+$('patienceSec').value, 10, 999999);
  const abdMode = $('abandonRateAssumption').value;

  const intervalSec = intervalMin * 60;

  const results = [];
  let totalVol=0, totalWorkSec=0, totalStaffedSec=0;
  let slWeighted=0, slWeight=0;
  let asaWeighted=0, asaWeight=0;
  let abdWeighted=0, abdWeight=0;

  for(const p of openSeries){
    const vol = p.volume;
    const ahtSec = Math.max(1, p.ahtSec);

    const lambda = vol / intervalSec;              // arrivals per second
    const a = lambda * ahtSec;                     // offered load in erlangs
    const staffRaw = staffForInterval(p.dt, intervalMin);
    const staffEff = effectiveStaff(staffRaw);
    const cAvail = Math.max(0, Math.floor(staffEff + 1e-9)); // integer agents for queue calc

    const cReq = requiredAgentsForSL(a, ahtSec, slTarget, slSeconds);
    const cReqEff = cReq; // requirement in heads

    const sl = (cAvail>0) ? serviceLevel(a, cAvail, slSeconds, ahtSec) : 0;
    const asa = (cAvail>0) ? asaSeconds(a, cAvail, ahtSec, maxWait) : maxWait;

    const abd = (abdMode==='none') ? 0 : estimateAbandonRate(asa, patience);

    const workSec = vol * ahtSec;
    const staffedSec = staffEff * intervalSec;

    const occ = staffedSec>0 ? Math.min(1, workSec / staffedSec) : 1;

    const deficit = Math.max(0, cReqEff - staffEff);
    const overtimeHrs = deficit * (intervalSec/3600);

    let status = 'OK';
    if(deficit > 0.0001) status = 'Deficit';
    else if(occ > 0.85 || sl < slTarget) status = 'Tight';

    results.push({
      dt: p.dt,
      volume: vol,
      ahtSec,
      workloadHrs: workSec/3600,
      staffRaw,
      staffEff,
      staffReq: cReqEff,
      status,
      occ,
      sl,
      asa,
      abd,
      overtimeHrs
    });

    totalVol += vol;
    totalWorkSec += workSec;
    totalStaffedSec += staffedSec;

    // weighted metrics (by volume)
    slWeighted += sl * vol; slWeight += vol;
    asaWeighted += asa * vol; asaWeight += vol;
    abdWeighted += abd * vol; abdWeight += vol;
  }

  const periodOcc = totalStaffedSec>0 ? Math.min(1, totalWorkSec/totalStaffedSec) : 1;
  const periodSL = slWeight>0 ? (slWeighted/slWeight) : 0;
  const periodASA = asaWeight>0 ? (asaWeighted/asaWeight) : 0;
  const periodABD = abdWeight>0 ? (abdWeighted/abdWeight) : 0;

  state.lastResults = results;
  state.lastSummary = {
    totalVol,
    occ: periodOcc,
    sl: periodSL,
    asa: periodASA,
    abd: periodABD,
    from: results[0].dt,
    to: results[results.length-1].dt,
    intervalMin
  };

  renderAll();
  setStatus(`Calculated ${results.length} intervals (${intervalMin} min) within opening hours.`);
}

function renderAll(){
  renderSummaryTiles();
  renderTable();
  renderChart();
  renderHealthCheck();
  renderNotes();
  $('downloadResultsBtn').disabled = !(state.lastResults && state.lastResults.length);
}

function renderSummaryTiles(){
  const s = state.lastSummary;
  if(!s) return;

  $('periodPill').textContent = `${toISOMinute(s.from)} ‚Üí ${toISOMinute(s.to)} (${s.intervalMin}m)`;

  $('tVol').textContent = fmtNum(s.totalVol, 0);
  $('tOcc').textContent = pct(s.occ);
  $('tSL').textContent  = pct(s.sl);
  $('tASA').textContent = fmtSecs(s.asa);
  $('tABD').textContent = pct(s.abd);
}

function renderTable(){
  const body = $('resultsBody');
  const rows = state.lastResults || [];
  if(!rows.length){
    body.innerHTML = `<tr><td colspan="12" class="muted" style="padding:16px;">No results yet.</td></tr>`;
    return;
  }

  body.innerHTML = rows.map(r=>{
    const dtEnd = addMinutes(r.dt, state.lastSummary.intervalMin);
    const label = `${toISOMinute(r.dt)} ‚Üí ${toISOMinute(dtEnd)}`;

    const statusBadge = badgeForStatus(r.status);

    return `
      <tr>
        <td>${label}</td>
        <td class="right">${fmtNum(r.volume,0)}</td>
        <td class="right">${fmtNum(r.ahtSec,0)}</td>
        <td class="right">${fmtNum(r.workloadHrs,2)}</td>
        <td class="right">${fmtNum(r.staffEff,2)}</td>
        <td class="right">${fmtNum(r.staffReq,0)}</td>
        <td class="center">${statusBadge}</td>
        <td class="right">${pct(r.occ)}</td>
        <td class="right">${pct(r.sl)}</td>
        <td class="right">${fmtSecs(r.asa)}</td>
        <td class="right">${pct(r.abd)}</td>
        <td class="right">${fmtNum(r.overtimeHrs,2)}</td>
      </tr>
    `;
  }).join('');
}

function renderChart(){
  const canvas = $('barChart');
  const ctx = canvas.getContext('2d');
  const rows = state.lastResults || [];
  const W = canvas.width, H = canvas.height;

  ctx.clearRect(0,0,W,H);

  if(!rows.length){
    ctx.fillStyle = '#6b7280';
    ctx.font = '14px Aptos, Segoe UI, Arial, sans-serif';
    ctx.fillText('No data to chart.', 16, 28);
    return;
  }

  // Build series for chart: staffEff vs staffReq
  const staff = rows.map(r=>r.staffEff);
  const req = rows.map(r=>r.staffReq);

  const maxY = Math.max(1, ...staff, ...req) * 1.15;

  const pad = {l:38, r:16, t:14, b:28};
  const innerW = W - pad.l - pad.r;
  const innerH = H - pad.t - pad.b;
  const n = rows.length;
  const barW = innerW / Math.max(1, n);
  const line = (x1,y1,x2,y2, stroke)=>{ ctx.strokeStyle=stroke; ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.stroke(); };

  // axes
  ctx.lineWidth = 1;
  line(pad.l, pad.t, pad.l, pad.t + innerH, '#cbd5e1');
  line(pad.l, pad.t + innerH, pad.l + innerW, pad.t + innerH, '#cbd5e1');

  // y labels (0, 50%, 100% of max)
  ctx.fillStyle = '#6b7280';
  ctx.font = '11px Aptos, Segoe UI, Arial, sans-serif';
  for(let i=0;i<=4;i++){
    const v = (maxY*i/4);
    const y = pad.t + innerH - (v/maxY)*innerH;
    ctx.fillText(String(Math.round(v)), 6, y+4);
    line(pad.l, y, pad.l+innerW, y, '#eef2f7');
  }

  // bars for staff (teal), line for req (dark teal)
  for(let i=0;i<n;i++){
    const x = pad.l + i*barW;
    const staffH = (staff[i]/maxY)*innerH;
    const y0 = pad.t + innerH - staffH;

    // staff bar
    ctx.fillStyle = '#1aa6a6';
    ctx.fillRect(x + barW*0.12, y0, barW*0.55, staffH);

    // requirement tick/line point
    const reqY = pad.t + innerH - (req[i]/maxY)*innerH;
    ctx.fillStyle = '#0f4c4c';
    ctx.beginPath();
    ctx.arc(x + barW*0.4, reqY, 2.3, 0, Math.PI*2);
    ctx.fill();

    // connect req points
    if(i>0){
      const prevX = pad.l + (i-1)*barW + barW*0.4;
      const prevY = pad.t + innerH - (req[i-1]/maxY)*innerH;
      const curX  = x + barW*0.4;
      ctx.strokeStyle = '#0f4c4c';
      ctx.lineWidth = 1.5;
      ctx.beginPath();
      ctx.moveTo(prevX, prevY);
      ctx.lineTo(curX, reqY);
      ctx.stroke();
      ctx.lineWidth = 1;
    }
  }

  // legend
  ctx.fillStyle = '#111827';
  ctx.font = '12px Aptos, Segoe UI, Arial, sans-serif';
  ctx.fillText('Staff scheduled (effective)', pad.l + 8, pad.t + 12);
  ctx.fillStyle = '#1aa6a6';
  ctx.fillRect(pad.l + 200, pad.t + 4, 10, 10);

  ctx.fillStyle = '#111827';
  ctx.fillText('Staff required (SL)', pad.l + 228, pad.t + 12);
  ctx.fillStyle = '#0f4c4c';
  ctx.beginPath(); ctx.arc(pad.l + 354, pad.t + 9, 3, 0, Math.PI*2); ctx.fill();
}

function renderHealthCheck(){
  const list = $('healthList');
  const headline = $('healthHeadline');
  const totals = $('healthTotals');

  const rows = state.lastResults || [];
  if(!rows.length){
    headline.textContent = 'Upload a forecast and hit ‚ÄúCalculate requirements‚Äù.';
    list.innerHTML = '';
    totals.textContent = '';
    return;
  }

  const deficits = rows
    .filter(r=>r.overtimeHrs > 0.0001)
    .sort((a,b)=>b.overtimeHrs - a.overtimeHrs);

  if(!deficits.length){
    headline.innerHTML = `‚úÖ No overtime required (based on your inputs).`;
    list.innerHTML = '';
    totals.textContent = '';
    return;
  }

  const intervalMin = state.lastSummary.intervalMin;
  const intervalHours = intervalMin/60;

  const totalOT = deficits.reduce((s,r)=>s+r.overtimeHrs,0);
  const worst = deficits[0];

  headline.innerHTML = `‚ö†Ô∏è Overtime needed in <strong>${deficits.length}</strong> interval(s). Biggest gap: <strong>${fmtNum(worst.overtimeHrs,2)}h</strong>.`;
  totals.textContent = `Total overtime across period: ${fmtNum(totalOT,2)}h (approx).`;

  const top = deficits.slice(0,8).map(r=>{
    const dtEnd = addMinutes(r.dt, intervalMin);
    const label = `${toISOMinute(r.dt)} ‚Üí ${toISOMinute(dtEnd)}`;
    const needHeads = Math.max(0, r.staffReq - r.staffEff);
    return `<li><strong>${label}</strong>: need +${fmtNum(needHeads,2)} staff (~${fmtNum(r.overtimeHrs,2)}h)</li>`;
  }).join('');

  list.innerHTML = top + (deficits.length>8 ? `<li class="muted">‚Ä¶and ${deficits.length-8} more interval(s).</li>` : '');
}

function renderNotes(){
  const rows = state.lastResults || [];
  if(!rows.length){ $('calcNotes').textContent=''; return; }

  const mode = $('staffingMode').value;
  const shrink = clampNum(+$('shrinkPct').value, 0, 95);
  const offline = clampNum(+$('offlinePct').value, 0, 95);
  const sl = clampNum(+$('slTarget').value, 0, 100);
  const slSec = clampNum(+$('slSeconds').value, 1, 999999);

  $('calcNotes').innerHTML =
    `Assumptions: Erlang C (M/M/c). Staffing shown is <strong>effective staff</strong> after shrink (${shrink}%) and offline (${offline}%). `
    + `SL target is <strong>${sl}%</strong> within <strong>${slSec}s</strong>. ABD is a simple estimate using customer patience.`;
}

/* ---------------------------
   Status / UX
---------------------------- */
function setStatus(msg, isErr=false){
  const el = $('forecastStatus');
  el.style.color = isErr ? 'var(--bad)' : 'var(--muted)';
  el.textContent = msg || '';
}

/* ---------------------------
   File uploads
---------------------------- */
$('forecastFile').addEventListener('change', async (e)=>{
  const f = e.target.files && e.target.files[0];
  if(!f) return;
  const text = await f.text();
  const parsed = parseCSV(text);

  // keep original objects, but ensure we can pick keys
  state.rawForecast = parsed.rows;
  state.baseSeries = [];
  state.series = [];
  state.lastResults = [];
  state.lastSummary = null;

  $('downloadForecastBtn').disabled = true;
  $('downloadResultsBtn').disabled = true;

  setStatus(`Loaded forecast rows: ${parsed.rows.length}. Pick interval + click ‚ÄúApply changes‚Äù, then ‚ÄúCalculate requirements‚Äù.`);
});

$('staffFile').addEventListener('change', async (e)=>{
  const f = e.target.files && e.target.files[0];
  if(!f) return;
  const text = await f.text();
  const parsed = parseCSV(text);
  const intervalMin = Number($('intervalSelect').value);
  state.staffSeries = normaliseStaffToInterval(parsed.rows, intervalMin);
  setStatus(`Loaded staffing rows: ${parsed.rows.length}.`);
});

$('staffingMode').addEventListener('change', ()=>{
  const mode = $('staffingMode').value;
  $('fteBlock').style.display = (mode==='fte') ? 'block' : 'none';
  $('staffFileBlock').style.display = (mode==='interval') ? 'block' : 'none';
});

$('intervalSelect').addEventListener('change', ()=>{
  // if staffing CSV loaded, re-normalise staffing series by re-reading not possible.
  // We'll just warn; user can re-upload.
  if(state.staffSeries && $('staffingMode').value==='interval'){
    setStatus('Interval changed. If you uploaded staffing per interval, please re-upload the staffing CSV to match.', true);
  }
});

/* ---------------------------
   Forecast shaping buttons
---------------------------- */
$('applyForecastBtn').addEventListener('click', ()=>{
  if(!state.rawForecast.length){
    setStatus('Upload a forecast CSV first.', true);
    return;
  }
  const intervalMin = Number($('intervalSelect').value);
  state.baseSeries = normaliseForecastToInterval(state.rawForecast, intervalMin);
  state.series = applyForecastAdjustments(state.baseSeries);
  const openSeries = filterToOpeningHours(state.series);

  $('downloadForecastBtn').disabled = !(state.series && state.series.length);

  const from = openSeries[0]?.dt;
  const to = openSeries[openSeries.length-1]?.dt;
  setStatus(`Forecast prepared: ${state.series.length} interval(s) total, ${openSeries.length} within opening hours.` + (from && to ? ` (${toISOMinute(from)} ‚Üí ${toISOMinute(to)})` : ''));
});

$('resetForecastBtn').addEventListener('click', ()=>{
  $('pctChange').value = 0;
  $('volDelta').value = 0;
  if(state.baseSeries.length){
    state.series = state.baseSeries.map(x=>({...x}));
    $('downloadForecastBtn').disabled = false;
    setStatus('Forecast adjustments reset to uploaded baseline.');
  } else if(state.rawForecast.length){
    setStatus('Click ‚ÄúApply changes‚Äù to rebuild the baseline series from the uploaded file.');
  } else {
    setStatus('Nothing to reset yet.');
  }
});

$('downloadForecastBtn').addEventListener('click', ()=>{
  if(!state.series || !state.series.length) return;
  const intervalMin = Number($('intervalSelect').value);
  const lines = ['datetime,volume,aht_seconds'];
  for(const r of state.series){
    lines.push(`${toISOMinute(r.dt)},${(r.volume ?? 0)},${Math.round(r.ahtSec ?? +$('ahtGlobal').value)}`);
  }
  downloadText(lines.join('\n'), `quick_capacity_forecast_${intervalMin}m.csv`);
});

/* ---------------------------
   Calculate / clear / downloads
---------------------------- */
$('calcBtn').addEventListener('click', ()=>{
  // ensure we have series built (if user forgot)
  if(state.rawForecast.length && !state.series.length){
    const intervalMin = Number($('intervalSelect').value);
    state.baseSeries = normaliseForecastToInterval(state.rawForecast, intervalMin);
    state.series = applyForecastAdjustments(state.baseSeries);
  }
  compute();
});

$('clearBtn').addEventListener('click', ()=>{
  state.rawForecast = [];
  state.baseSeries = [];
  state.series = [];
  state.staffSeries = null;
  state.lastResults = [];
  state.lastSummary = null;

  $('forecastFile').value = '';
  $('staffFile').value = '';
  $('downloadForecastBtn').disabled = true;
  $('downloadResultsBtn').disabled = true;

  $('resultsBody').innerHTML = `<tr><td colspan="12" class="muted" style="padding:16px;">No results yet.</td></tr>`;
  $('periodPill').textContent = 'No data';
  $('tVol').textContent = '‚Äî';
  $('tOcc').textContent = '‚Äî';
  $('tSL').textContent = '‚Äî';
  $('tASA').textContent = '‚Äî';
  $('tABD').textContent = '‚Äî';
  $('healthHeadline').textContent = 'Upload a forecast and hit ‚ÄúCalculate requirements‚Äù.';
  $('healthList').innerHTML = '';
  $('healthTotals').textContent = '';
  $('calcNotes').textContent = '';

  const ctx = $('barChart').getContext('2d');
  ctx.clearRect(0,0,$('barChart').width,$('barChart').height);

  setStatus('Cleared.');
});

$('downloadResultsBtn').addEventListener('click', ()=>{
  if(!state.lastResults || !state.lastResults.length) return;
  const lines = [
    'interval_start,interval_end,volume,aht_seconds,workload_hours,staff_effective,staff_required,status,occupancy,service_level,asa_seconds,abd,ot_hours'
  ];
  for(const r of state.lastResults){
    const start = toISOMinute(r.dt);
    const end = toISOMinute(addMinutes(r.dt, state.lastSummary.intervalMin));
    lines.push([
      start, end,
      roundSafe(r.volume, 0),
      roundSafe(r.ahtSec, 0),
      roundSafe(r.workloadHrs, 4),
      roundSafe(r.staffEff, 4),
      roundSafe(r.staffReq, 0),
      r.status,
      roundSafe(r.occ, 6),
      roundSafe(r.sl, 6),
      roundSafe(r.asa, 2),
      roundSafe(r.abd, 6),
      roundSafe(r.overtimeHrs, 4)
    ].join(','));
  }
  downloadText(lines.join('\n'), `quick_capacity_results_${state.lastSummary.intervalMin}m.csv`);
});

function roundSafe(x, dp){
  if(x==null || !isFinite(x)) return '';
  const p = Math.pow(10, dp);
  return Math.round(x*p)/p;
}

function downloadText(text, filename){
  const blob = new Blob([text], {type:'text/csv;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

/* ---------------------------
   Little niceties
---------------------------- */
(function init(){
  // Just so it matches your other apps: calm defaults, no extra corner labels. üôÇ
  setStatus('Ready. Upload a forecast CSV to begin.');
})();
</script>
</body>
</html>
